# 더그림 작업관리 시스템 개발 계획

## 📊 현재 구현 상태 (2025-01-08 최신화)

### ✅ 완료된 기능

#### 1. 기본 구조
- ✅ Next.js 16 기반 프로젝트 설정
- ✅ TypeScript 설정
- ✅ Tailwind CSS 스타일링
- ✅ shadcn/ui 컴포넌트 라이브러리 통합
- ✅ Zustand 상태 관리

#### 2. UI 컴포넌트
- ✅ 네비게이션 바 (웹툰별/공정별 뷰 전환, 검색)
- ✅ 웹툰별 뷰 레이아웃 (웹툰 → 회차 → 컷 → 파일)
- ✅ 공정별 뷰 레이아웃 (공정 목록 → 파일 목록)
- ✅ 검색 결과 화면

#### 3. 데이터 표시
- ✅ 웹툰 목록 표시
- ✅ 회차 목록 표시
- ✅ 컷 목록 표시
- ✅ 파일 그리드 표시 (공정별)
- ✅ 검색 결과 표시 (description 및 메타데이터 기반)
- ✅ 파일 상세 정보 Dialog

#### 4. 웹툰 관리
- ✅ 웹툰 목록 조회
- ✅ 웹툰 생성 (Dialog)
- ✅ 웹툰 수정 (Dialog)
- ✅ 웹툰 삭제
- ✅ 웹툰 선택 기능

#### 5. 회차 관리
- ✅ 회차 목록 조회
- ✅ 회차 생성 (Dialog)
- ✅ 회차 수정 (Dialog)
- ✅ 회차 삭제
- ✅ 회차 선택 기능

#### 6. 컷 관리
- ✅ 컷 목록 조회
- ✅ 컷 생성 (Dialog)
- ✅ 컷 수정 (Dialog)
- ✅ 컷 삭제
- ✅ 컷 선택 기능

#### 7. 파일 관리
- ✅ 파일 업로드 기능
- ✅ 파일 목록 조회 (공정별, 컷별)
- ✅ 파일 검색 기능 (기본 - description 기반)
- ✅ 파일 다운로드 기능
- ✅ 파일 삭제 기능
- ✅ 파일 정보 수정 기능 (description, 빈 문자열일 때만 수정 가능)

#### 8. API 계층
- ✅ Supabase 클라이언트 설정
- ✅ 웹툰 API (CRUD)
- ✅ 회차 API (CRUD)
- ✅ 컷 API (CRUD)
- ✅ 공정 API (CRUD, 순서 변경)
- ✅ 파일 API (조회, 검색, 업로드, 다운로드, 삭제)
- ✅ 이미지 분석 API (Gemini 2.5 Pro 연동)

#### 9. 공정 관리
- ✅ 공정 생성 기능
- ✅ 공정 수정 기능
- ✅ 공정 삭제 기능
- ✅ 공정 순서 변경 기능 (화살표 버튼)

#### 10. UI/UX 개선
- ✅ 제목 변경 (더그림 작업관리 시스템)
- ✅ 버튼 위치 개선 (제목 아래, 전체 너비)
- ✅ 카드 전체 클릭 가능하도록 개선
- ✅ 목록 스크롤 기능 추가
- ✅ 컷 목록 제목이 선택된 회차 제목으로 동적 변경

#### 11. 인증 및 권한 관리
- ✅ 사용자 인증 시스템 (로그인, 회원가입, 로그아웃)
- ✅ 세션 관리 및 인증 상태 보호
- ✅ 관리자 초대 시스템 (이메일 발송, 토큰 관리)
- ✅ 역할 기반 권한 관리 (admin, manager, staff, viewer)
- ✅ 권한 체크 유틸리티 함수
- ✅ UI 요소 권한별 표시/숨김 (모든 컴포넌트 적용)
- ✅ 관리자 페이지 (사용자 관리, 초대 관리)
- ✅ Row Level Security (RLS) 정책 (user_profiles, invitations)

---

### ⚠️ 부분 구현 / 미구현 기능

#### 1. 검색 기능 (부분 구현)
- ✅ 기본 검색 기능 (description 기반)
- ❌ 다중 필드 검색 (파일명, 웹툰명, 회차명 등)
- ❌ 고급 검색 필터
- ❌ 검색 결과 정렬 및 개선

#### 2. 파일 관리
- ✅ 파일 정보 수정 기능 완료

#### 2. 인증 및 권한 관리
- ✅ 사용자 인증 시스템 (로그인, 회원가입, 로그아웃, 세션 관리)
- ✅ 관리자 초대 시스템 (이메일 발송, 토큰 생성, 초대 링크 회원가입)
- ✅ 역할 기반 권한 관리 (admin, manager, staff, viewer)
- ✅ Row Level Security (RLS) 정책 (user_profiles, invitations)
- ⚠️ 프로덕션용 RLS 정책 (웹툰/회차/컷/파일/공정 테이블 역할별 접근 권한)
- ❌ 비밀번호 재설정 기능

#### 3. 환경 설정
- ⚠️ `.env.local` 파일 없음 (Supabase 연결 필요)

---

## 🎯 다음 개발 계획

### Phase 1: 기본 CRUD 기능 완성 (우선순위: 높음)

#### 1.1 회차 관리 기능 구현 ✅ 완료
- [x] `lib/api/episodes.ts`에 `createEpisode`, `updateEpisode`, `deleteEpisode` 함수 구현
- [x] `EpisodeList.tsx`에 회차 생성 Dialog 추가
- [x] `EpisodeList.tsx`에 회차 수정 Dialog 추가
- [x] `EpisodeList.tsx`에 회차 삭제 기능 추가
- [x] `WebtoonList.tsx`와 동일한 패턴으로 구현

**완료일**: 2025-01-06

#### 1.2 컷 관리 기능 구현 ✅ 완료
- [x] `lib/api/cuts.ts`에 `createCut`, `updateCut`, `deleteCut` 함수 구현
- [x] `CutList.tsx`에 컷 생성 Dialog 추가
- [x] `CutList.tsx`에 컷 수정 Dialog 추가
- [x] `CutList.tsx`에 컷 삭제 기능 추가
- [x] `WebtoonList.tsx`와 동일한 패턴으로 구현

**완료일**: 2025-01-06

#### 1.3 공정 관리 기능 구현 ✅ 완료
- [x] `ProcessView.tsx`에 공정 생성 Dialog 추가
- [x] `ProcessView.tsx`에 공정 수정 Dialog 추가
- [x] `ProcessView.tsx`에 공정 삭제 기능 추가
- [x] `lib/api/processes.ts`에 `createProcess`, `updateProcess`, `deleteProcess` 함수 구현
- [x] 공정 순서 변경 기능 (화살표 버튼)

**완료일**: 2025-01-07

---

### Phase 2: 파일 관리 기능 구현 (우선순위: 높음)

#### 2.1 파일 업로드 기능 ✅ 완료
- [x] `FileGrid.tsx`에 파일 업로드 Dialog 추가
- [x] `react-dropzone`을 사용한 드래그 앤 드롭 업로드 UI
- [x] `lib/api/files.ts`에 `uploadFile` 함수 구현
- [x] Supabase Storage 연동
- [x] 업로드 진행률 표시
- [x] 파일 타입 검증 (이미지, PSD, AI 등)

**완료일**: 2025-01-06

#### 2.2 파일 다운로드/삭제 기능 ✅ 완료
- [x] `FileGrid.tsx`에 파일 다운로드 기능 구현
- [x] `FileGrid.tsx`에 파일 삭제 기능 구현
- [x] `lib/api/files.ts`에 `deleteFile` 함수 구현 (Storage + DB)
- [x] 삭제 확인 Dialog 추가

**완료일**: 2025-01-07

#### 2.3 파일 정보 수정 기능 ✅ 완료
- [x] 파일 설명 수정 기능 (Dialog)
- [x] 빈 문자열일 때만 수정 가능 (AI 자동 생성 전까지)
- [x] 권한 체크 (업로드 권한 있는 사용자만)
- [x] 파일 메타데이터 수정 기능 (재분석 기능으로 구현)

**완료일**: 2025-01-07

#### 2.4 이미지 메타데이터 자동 생성 기능 ✅ 완료
- [x] Gemini 2.5 Pro API 통합 (`app/api/analyze-image/route.ts`)
- [x] 이미지 업로드 시 자동 분석 기능
- [x] 수동 분석/재분석 기능 (파일 그리드에서 버튼 클릭)
- [x] 메타데이터 자동 폴링 및 UI 업데이트 (3초 간격)
- [x] 메타데이터 표시 UI (파일 그리드 및 상세 정보)
- [x] 메타데이터 구조: `scene_summary`, `tags`, `characters_count`, `analyzed_at`
- [x] 분석 진행 상태 표시 (로딩 애니메이션)
- [x] 이미지 URL 접근 대기 및 재시도 로직
- [x] 상세 디버깅 로그 추가

**완료일**: 2025-01-08

#### 2.5 파일 상세 정보 Dialog ✅ 완료
- [x] 파일 클릭 시 상세 정보 팝업 표시
- [x] 화면 전체 크기 Dialog (95vw x 95vh)
- [x] 파일 미리보기 (이미지: 60vh 높이)
- [x] 기본 정보 카드 (파일명, 크기, MIME 타입, 생성일, 설명)
- [x] 메타데이터 카드 (장면 요약, 태그, 등장 인물 수, 분석 일시)
- [x] 반응형 레이아웃 (PC: 가로 배열, 모바일: 세로 배열)
- [x] 액션 버튼 (다운로드, 분석, 삭제)

**완료일**: 2025-01-08

---

### Phase 3: 사용자 경험 개선 (우선순위: 중간)

#### 3.1 로딩 상태 개선
- [ ] 스켈레톤 UI 추가
- [ ] 로딩 중 에러 처리 개선
- [ ] Toast 알림 (react-hot-toast 또는 shadcn/ui toast)

**예상 소요 시간**: 2-3시간

#### 3.2 에러 처리 개선
- [ ] 전역 에러 핸들링
- [ ] 사용자 친화적인 에러 메시지
- [ ] 네트워크 오류 처리

**예상 소요 시간**: 2-3시간

#### 3.3 UI/UX 개선
- [x] 제목 변경 (더그림 작업관리 시스템) ✅
- [x] 버튼 위치 개선 (제목 아래, 전체 너비) ✅
- [x] 카드 전체 클릭 가능하도록 개선 ✅
- [x] 목록 스크롤 기능 추가 ✅
- [x] 컷 목록 제목이 선택된 회차 제목으로 동적 변경 ✅
- [ ] 반응형 디자인 개선
- [ ] 키보드 단축키 지원
- [ ] 파일 미리보기 개선 (모달, 확대 등)
- [ ] 이미지 로딩 최적화

**예상 소요 시간**: 3-4시간 (일부 완료)

---

### Phase 4: 인증 및 권한 관리 시스템 (우선순위: 높음) ✅ 대부분 완료

#### 4.1 데이터베이스 스키마 확장 ✅ 완료
- [x] `user_profiles` 테이블 생성 (Supabase Auth와 연동)
- [x] `invitations` 테이블 생성 (초대 토큰 관리)
- [x] 역할 타입 정의 (admin, manager, staff, viewer)
- [x] 자동 프로필 생성 트리거
- [x] 인덱스 생성

**완료일**: 2025-01-07

#### 4.2 관리자 초대 시스템 ✅ 완료
- [x] 초대 이메일 발송 기능 (Edge Function 연동)
- [x] 초대 토큰 생성 및 관리
- [x] 초대 링크를 통한 회원가입 페이지
- [x] 초대 토큰 검증 및 계정 생성
- [x] 초대 시 권한 자동 부여
- [x] 초대 만료 시간 설정 (7일)
- [x] 첫 사용자 자동 관리자 부여

**완료일**: 2025-01-07

#### 4.3 사용자 인증 시스템 ✅ 완료
- [x] Supabase Auth 통합
- [x] 로그인 페이지 구현 (`app/login/page.tsx`)
- [x] 회원가입 페이지 구현 (`app/signup/page.tsx`, 초대 링크 지원)
- [x] 로그아웃 기능
- [x] 세션 관리 (`useAuth` 훅)
- [x] 인증 상태 보호 (메인 페이지 리다이렉트)
- [ ] 비밀번호 재설정 기능

**완료일**: 2025-01-07

#### 4.4 권한 관리 시스템 ✅ 완료
- [x] 역할 기반 접근 제어 (RBAC)
- [x] 권한 체크 유틸리티 함수 (`lib/utils/permissions.ts`)
- [x] UI 요소 권한별 표시/숨김 (모든 컴포넌트에 적용)
- [x] 관리자 전용 페이지 (`app/admin/page.tsx`)
  - [x] 사용자 관리 (역할 변경)
  - [x] 초대 관리 (생성, 목록 조회, 링크 복사)
- [ ] API 엔드포인트 권한 검증 (서버 사이드)

**완료일**: 2025-01-07

#### 4.5 Row Level Security (RLS) 정책 ⚠️ 부분 완료
- [x] `user_profiles` 테이블 RLS 정책 설정
- [x] `invitations` 테이블 RLS 정책 설정
- [x] Storage 버킷 RLS 정책 설정 (개발용)
- [ ] 웹툰 테이블 RLS 정책 설정 (프로덕션용)
- [ ] 회차 테이블 RLS 정책 설정 (프로덕션용)
- [ ] 컷 테이블 RLS 정책 설정 (프로덕션용)
- [ ] 파일 테이블 RLS 정책 설정 (프로덕션용)
- [ ] 공정 테이블 RLS 정책 설정 (프로덕션용)
- [ ] 역할별 접근 권한 정의 (프로덕션용)

**현재 상태**: 개발용으로 모든 사용자에게 접근 허용 (`supabase-rls-policies.sql`)
**프로덕션 배포 전 필수**: 역할별 접근 권한을 정의한 RLS 정책 설정 필요

**완료일**: 2025-01-07 (기본 RLS 정책)

**총 진행률**: 약 85% 완료

---

### Phase 5: 검색 기능 개선 (우선순위: 높음) ⚠️ 급함

#### 5.1 기본 검색 기능 ✅ 완료
- [x] 파일 description 기반 검색
- [x] 검색 입력 필드 (Navigation)
- [x] 검색 결과 표시 (SearchResults)
- [x] 최소 2자 이상 입력 검색

**완료일**: 초기 구현

#### 5.1.1 메타데이터 검색 기능 ✅ 완료
- [x] `metadata.scene_summary` 검색 지원
- [x] `metadata.tags` 배열 검색 지원
- [x] `search_files_fulltext` RPC 함수 확장
- [x] 메타데이터 JSONB 필드 GIN 인덱스 추가
- [x] 검색 성능 최적화

**완료일**: 2025-01-08

#### 5.2 검색 기능 확장 (부분 완료)
- [x] 메타데이터 검색 (scene_summary, tags) ✅
- [ ] 파일명으로 검색
- [ ] 웹툰명으로 검색
- [ ] 회차명으로 검색
- [ ] 컷 제목으로 검색
- [ ] 다중 필드 통합 검색 (description, 파일명, 웹툰/회차/컷 정보)

**완료일**: 2025-01-08 (메타데이터 검색)
**예상 소요 시간**: 2-3시간 (나머지 기능)

#### 5.3 고급 검색 필터
- [ ] 날짜 범위 필터 (생성일, 수정일)
- [ ] 파일 타입 필터 (이미지, PDF, PSD 등)
- [ ] 공정별 필터
- [ ] 웹툰별 필터
- [ ] 파일 크기 필터

**예상 소요 시간**: 3-4시간

#### 5.4 검색 결과 개선
- [ ] 검색 결과 정렬 (날짜, 이름, 크기 등)
- [ ] 검색 결과 하이라이트 (검색어 강조)
- [ ] 검색 결과에서 파일 다운로드/삭제 기능
- [ ] 검색 결과에서 해당 컷으로 이동 기능

**예상 소요 시간**: 2-3시간

#### 5.5 검색 UX 개선
- [ ] 검색 히스토리 (최근 검색어)
- [ ] 자동완성/제안 기능
- [ ] 검색 결과 개수 표시 개선
- [ ] 검색 중 로딩 상태 개선
- [ ] 검색 결과 없을 때 개선된 UI

**예상 소요 시간**: 2-3시간

**총 예상 소요 시간**: 9-13시간

---

### Phase 6: 파일 관리 고급 기능 (우선순위: 낮음)

#### 6.1 파일 관리 고급 기능
- [ ] 일괄 업로드
- [ ] 일괄 다운로드
- [ ] 파일 버전 관리
- [ ] 썸네일 자동 생성

**예상 소요 시간**: 5-6시간

#### 6.2 통계 및 대시보드
- [ ] 웹툰별 진행률 표시
- [ ] 공정별 통계
- [ ] 파일 사용량 통계

**예상 소요 시간**: 4-5시간

---

## 🚀 즉시 진행 가능한 작업

### 1. 환경 변수 설정 확인
```bash
# .env.local 파일 생성 필요
NEXT_PUBLIC_SUPABASE_URL=your-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-key
GEMINI_API_KEY=your-gemini-api-key
```

**참고**: Gemini API 키는 [Google AI Studio](https://makersuite.google.com/app/apikey)에서 발급받을 수 있습니다.

### 2. 다음 우선순위 작업
1. **검색 기능 개선** (파일명, 웹툰명, 회차명 등 다중 필드 검색) ⚠️ 급함
2. **프로덕션용 RLS 정책 설정** (웹툰/회차/컷/파일/공정 테이블 역할별 접근 권한) ⭐ 프로덕션 필수
3. **비밀번호 재설정 기능** (인증 시스템 완성)
4. **Toast 알림 시스템** (UX 개선)
5. **파일 미리보기 개선** (UX 개선)

---

## 📝 개발 시 주의사항

### 코드 스타일
- 기존 코드 스타일 유지
- 불필요한 공백 제거
- 한 줄에 들어갈 수 있는 속성은 한 줄로 작성
- 컴포넌트 옵션 사이 불필요한 빈 줄 제거

### 에러 처리
- try-catch로 모든 비동기 작업 감싸기
- 사용자에게 명확한 에러 메시지 표시
- 콘솔 에러 로깅 유지

### 상태 관리
- Zustand store에 필요한 상태만 저장
- 불필요한 리렌더링 방지
- 로컬 상태와 전역 상태 구분

---

## 🔍 현재 확인된 이슈

1. **Supabase 연결 문제 가능성**
   - `.env.local` 파일이 없어서 API 호출 실패 가능
   - 환경 변수 설정 후 개발 서버 재시작 필요

2. **Dialog z-index 문제**
   - `WebtoonList.tsx`의 Dialog에 `z-[100]` 설정되어 있음
   - 다른 Dialog들도 동일하게 설정 필요할 수 있음

3. **이미지 로딩 오류 가능성**
   - Next.js Image 컴포넌트 사용 시 외부 도메인 설정 필요할 수 있음
   - `next.config.ts`에 Supabase 이미지 도메인 추가 필요

4. **보안 이슈 (프로덕션 배포 전 필수 해결)**
   - ✅ 인증 시스템 구현 완료
   - ⚠️ RLS 정책 부분 완료 (user_profiles, invitations 완료, 나머지는 개발용)
   - ⚠️ 프로덕션용 RLS 정책 필요 (웹툰/회차/컷/파일/공정 테이블 역할별 접근 권한)
   - ⚠️ Storage 버킷 RLS 정책 프로덕션용 설정 필요

---

## 📚 참고 자료

- [Next.js 문서](https://nextjs.org/docs)
- [Supabase 문서](https://supabase.com/docs)
- [Supabase Auth 문서](https://supabase.com/docs/guides/auth)
- [Supabase RLS 문서](https://supabase.com/docs/guides/auth/row-level-security)
- [Gemini API 문서](https://ai.google.dev/docs)
- [Google AI Studio](https://makersuite.google.com/app/apikey) - API 키 발급
- [shadcn/ui 문서](https://ui.shadcn.com)
- [Zustand 문서](https://zustand-demo.pmnd.rs)
- [react-dropzone 문서](https://react-dropzone.js.org)

---

## 🔐 인증 시스템 상세 설계 (✅ 구현 완료)

### 구현된 기능

#### 1. 사용자 인증
- **로그인**: `app/login/page.tsx` - 이메일/비밀번호 로그인
- **회원가입**: `app/signup/page.tsx` - 초대 토큰 기반 회원가입, 첫 사용자 자동 관리자
- **로그아웃**: Navigation 컴포넌트에서 로그아웃 버튼
- **세션 관리**: `lib/hooks/useAuth.ts` - 인증 상태 자동 감지 및 관리

#### 2. 관리자 초대 시스템
- **초대 생성**: `lib/api/auth.ts` - `createInvitation()` 함수
- **이메일 발송**: Edge Function 연동 (`send-invitation-email`)
- **초대 토큰**: UUID 기반, 7일 만료
- **초대 관리**: `app/admin/page.tsx` - 초대 목록 조회, 링크 복사

#### 3. 권한 관리
- **권한 체크**: `lib/utils/permissions.ts` - 모든 권한 체크 함수 구현
- **UI 적용**: 모든 컴포넌트에 권한별 버튼 표시/숨김 적용
  - `WebtoonList.tsx`, `EpisodeList.tsx`, `CutList.tsx`
  - `FileGrid.tsx`, `ProcessView.tsx`
- **관리자 페이지**: `/admin` - 사용자 관리, 초대 관리

#### 4. 데이터베이스 스키마
- **파일**: `supabase-auth-schema.sql`
- **테이블**: `user_profiles`, `invitations`
- **트리거**: 자동 프로필 생성 (`handle_new_user`)
- **RLS 정책**: `user_profiles`, `invitations` 테이블 보안 정책 적용

### 사용자 역할 정의

1. **admin (관리자)**
   - 모든 기능 접근 가능
   - 사용자 관리 (초대, 권한 변경)
   - 관리자 페이지 접근 (`/admin`)

2. **manager (매니저)**
   - 웹툰/회차/컷 생성/수정/삭제
   - 파일 업로드/다운로드/삭제
   - 공정 관리
   - 사용자 초대 불가

3. **staff (스태프)**
   - 웹툰/회차/컷 조회
   - 파일 업로드/다운로드
   - 자신이 업로드한 파일만 삭제 가능
   - 생성/수정/삭제 제한

4. **viewer (조회자)**
   - 모든 데이터 조회만 가능
   - 파일 다운로드 가능
   - 생성/수정/삭제 불가

### 초대 프로세스 (✅ 구현 완료)

1. **관리자가 초대 발송**
   - 관리자 페이지 (`/admin`) 접근
   - 이메일 주소 입력, 역할 선택
   - 초대 토큰 자동 생성 (UUID, 만료 시간 7일)
   - 이메일 자동 발송 (Edge Function)

2. **초대 수신자가 회원가입**
   - 초대 링크 클릭: `/signup?token={토큰}`
   - 토큰 자동 검증
   - 이메일, 비밀번호 입력
   - 계정 생성 및 역할 자동 부여
   - 로그인 페이지로 리다이렉트

3. **초대 관리**
   - 초대 목록 조회 (발송자, 수신자, 상태, 만료일)
   - 초대 링크 복사 기능
   - 초대 상태 확인 (대기중/사용됨/만료됨)

### 주요 파일 구조

```
lib/
├── api/
│   ├── auth.ts          # 인증 API (로그인, 회원가입, 초대 등)
│   ├── admin.ts         # 관리자 유틸리티
│   └── files.ts         # 파일 API (업로드, 다운로드, 삭제, 분석)
├── hooks/
│   └── useAuth.ts       # 인증 상태 관리 훅
└── utils/
    └── permissions.ts   # 권한 체크 유틸리티

app/
├── api/
│   └── analyze-image/
│       └── route.ts     # Gemini API 이미지 분석 엔드포인트
├── login/
│   └── page.tsx         # 로그인 페이지
├── signup/
│   └── page.tsx         # 회원가입 페이지
└── admin/
    └── page.tsx         # 관리자 페이지

components/
└── FileGrid.tsx         # 파일 그리드 (업로드, 메타데이터 표시, 상세 정보)

supabase-auth-schema.sql  # 인증 스키마
supabase-rls-policies.sql  # RLS 정책 (개발용)
supabase-schema.sql        # 데이터베이스 스키마 (메타데이터 검색 함수 포함)
```

### 프로덕션 배포 전 필수 작업

1. **프로덕션용 RLS 정책 설정**
   - 웹툰/회차/컷/파일/공정 테이블 역할별 접근 권한 정의
   - Storage 버킷 역할별 접근 권한 설정

2. **비밀번호 재설정 기능**
   - Supabase Auth의 비밀번호 재설정 기능 연동

3. **API 엔드포인트 권한 검증**
   - 서버 사이드 권한 검증 추가 (현재는 클라이언트 사이드만)

---

## 🤖 이미지 메타데이터 자동 생성 시스템 (✅ 구현 완료)

### 개요
Gemini 2.5 Pro API를 활용하여 웹툰 장면 이미지의 메타데이터를 자동으로 생성하고 검색에 활용하는 시스템입니다.

### 구현된 기능

#### 1. 이미지 분석 API
- **파일**: `app/api/analyze-image/route.ts`
- **기능**: 
  - Gemini 2.5 Pro API를 통한 이미지 분석
  - 장면 요약, 태그, 등장 인물 수 추출
  - JSON 형식 응답 반환
- **프롬프트**: 웹툰 장면 분석에 특화된 프롬프트 사용
- **에러 처리**: 상세한 디버깅 로그 및 에러 메시지

#### 2. 자동 분석 기능
- **파일**: `lib/api/files.ts`
- **기능**:
  - 이미지 업로드 시 자동으로 분석 시작 (비동기)
  - 이미지 URL 접근 가능 여부 확인 및 재시도 로직
  - 분석 결과를 `metadata` JSONB 필드에 저장
- **메타데이터 구조**:
  ```json
  {
    "scene_summary": "한 문장으로 된 장면 요약",
    "tags": ["태그1", "태그2", "태그3"],
    "characters_count": 2,
    "analyzed_at": "2025-01-08T12:00:00.000Z"
  }
  ```

#### 3. 수동 분석/재분석 기능
- **파일**: `components/FileGrid.tsx`
- **기능**:
  - 파일 그리드에서 Sparkles 아이콘 버튼 클릭
  - 메타데이터가 없으면 "분석" 버튼 표시
  - 메타데이터가 있으면 "재분석" 버튼 표시
  - 분석 중 로딩 상태 표시

#### 4. 메타데이터 자동 업데이트
- **파일**: `components/FileGrid.tsx`
- **기능**:
  - 업로드된 이미지 파일을 `pendingAnalysisFiles`에 추가
  - 3초마다 폴링하여 메타데이터 생성 여부 확인
  - 메타데이터 생성 완료 시 자동으로 파일 목록 업데이트
  - "메타데이터 생성 중..." 상태 표시

#### 5. 메타데이터 표시 UI
- **파일 그리드**: 
  - 장면 요약 표시 (line-clamp-2)
  - 태그를 Badge 형태로 표시 (최대 5개 + 나머지 개수)
- **상세 정보 Dialog**:
  - 기본 정보 카드와 메타데이터 카드로 분리
  - PC: 가로 배열, 모바일: 세로 배열
  - 전체 메타데이터 정보 표시

#### 6. 검색 기능 확장
- **파일**: `supabase-schema.sql`
- **기능**:
  - `search_files_fulltext` RPC 함수 확장
  - `metadata.scene_summary` 검색 지원
  - `metadata.tags` 배열 검색 지원
  - 메타데이터 JSONB 필드 GIN 인덱스 추가

### 기술 스택
- **Gemini API**: Google Gemini 2.5 Pro
- **Next.js API Routes**: 서버 사이드 API 호출
- **Supabase**: 메타데이터 JSONB 저장 및 검색

### 환경 변수
```bash
GEMINI_API_KEY=your-gemini-api-key
```

### 메타데이터 생성 프로세스

1. **이미지 업로드**
   - 파일이 Supabase Storage에 업로드됨
   - DB에 파일 정보 저장 (`metadata: {}`)
   - 이미지 파일인 경우 자동으로 분석 시작

2. **이미지 분석**
   - 이미지 URL 접근 가능 여부 확인 (최대 5초 대기)
   - Gemini API 호출
   - 분석 결과 파싱 및 검증

3. **메타데이터 저장**
   - 분석 결과를 `metadata` JSONB 필드에 저장
   - `analyzed_at` 타임스탬프 추가

4. **UI 업데이트**
   - 폴링을 통해 메타데이터 생성 완료 감지
   - 파일 목록 자동 업데이트
   - 메타데이터 표시

### 검색 활용
- 메타데이터의 `scene_summary`와 `tags`가 검색 대상에 포함됨
- 예: "화해" 태그로 검색하면 해당 태그가 포함된 이미지 검색 가능
- 예: "두 사람이 대화하는 장면" 같은 자연어 검색 가능

**완료일**: 2025-01-08

